// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 1. Users Table (Central Auth)
model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  passwordHash String?  @map("password_hash")
  role         Role
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  name         String   @db.VarChar(100)

  // Relations
  brandProfile   BrandProfile?
  // Revised Creator Profile
  creatorProfile CreatorProfile?

  // A user (Brand) can own many campaigns
  brandCampaigns Campaign[] @relation("BrandCampaigns")

  // A user (Creator) can have many collaborations
  creatorCollabs CampaignCollaboration[] @relation("CreatorCollaborations")

  // Financials and Content
  transactions     Transaction[]
  analytics        AnalyticsDaily[]
  posts            CommunityPost[]
  socialAccounts   SocialAccount[]
  invoices         Invoice[]
  contentFeedbacks ContentFeedback[]
  documents        Document[]
  meetings         Meeting[]

  @@index([email])
  @@index([role])
  @@map("users")
}

// 2. Brand Profiles (One-to-One with Users)
model BrandProfile {
  userId       Int           @id @map("user_id")
  companyName  String        @map("company_name") @db.VarChar(100)
  tagline      String?       @db.VarChar(255)
  industry     String?       @db.VarChar(50)
  location     String?       @db.VarChar(100)
  about        String?       @db.Text
  logoUrl      String?       @map("logo_url") @db.LongText
  bannerUrl    String?       @map("banner_url") @db.LongText
  companySize  CompanySize?  @default(Startup) @map("company_size")
  hiringStatus HiringStatus? @default(Active) @map("hiring_status")
  hiringSince  Int?          @map("hiring_since")
  websiteUrl   String?       @map("website_url") @db.VarChar(255)
  socialLinks  Json?         @map("social_links")
  contactEmail String?       @map("contact_email") @db.VarChar(255)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("brand_profiles")
}

// 3. Creator Profiles (One-to-One with Users)
model CreatorProfile {
  userId            Int       @id @map("user_id")
  fullName          String    @map("full_name") @db.VarChar(100)
  handle            String    @db.VarChar(50)
  tagline           String?   @db.VarChar(255)
  avatarUrl         String?   @map("avatar_url") @db.LongText
  primaryPlatform   Platform? @map("primary_platform")
  location          String?   @db.VarChar(100)
  about             String?   @db.Text
  nicheTags         Json?     @map("niche_tags")
  followersCount    Int?      @default(0) @map("followers_count")
  engagementRate    Decimal?  @map("engagement_rate") @db.Decimal(5, 2)
  basePrice         Decimal?  @map("base_price") @db.Decimal(10, 2)
  socialLinks       Json?     @map("social_links")
  rating            Decimal?  @default(5.00) @db.Decimal(3, 2)
  brandAffiliations Json?     @map("brand_affiliations") // List of brands worked with

  // Media Kit
  mediaKitEnabled    Boolean   @default(true) @map("media_kit_enabled")
  mediaKitCustomSlug String?   @unique @map("media_kit_slug") @db.VarChar(50)
  statsLastUpdated   DateTime? @map("stats_last_updated")

  // ReachVerified Badge System
  verificationTier   VerificationTier? @default(None) @map("verification_tier")
  reliabilityScore   Int?              @default(0) @map("reliability_score")
  completedCampaigns Int               @default(0) @map("completed_campaigns")
  onTimeDeliveryRate Decimal?          @map("on_time_delivery_rate") @db.Decimal(5, 2)
  brandSafetyScore   Int?              @default(100) @map("brand_safety_score")

  // Payout Integration (Tazapay)
  tazapayBeneficiaryId String?           @map("tazapay_beneficiary_id") @db.VarChar(100)
  tazapayEntityId      String?           @map("tazapay_entity_id") @db.VarChar(100)
  onboardingStatus     OnboardingStatus? @default(NotStarted) @map("onboarding_status")
  onboardingLinkUrl    String?           @map("onboarding_link_url") @db.VarChar(500)
  onboardingExpiresAt  DateTime?         @map("onboarding_expires_at")
  payoutStatus         PayoutStatus?     @default(Inactive) @map("payout_status")
  bankCountry          String?           @map("bank_country") @db.VarChar(5)
  bankCurrency         String?           @map("bank_currency") @db.VarChar(5)
  bankName             String?           @map("bank_name") @db.VarChar(100)
  bankLastFour         String?           @map("bank_last_four") @db.VarChar(4)
  bankingSetupAt       DateTime?         @map("banking_setup_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  demographics CreatorDemographics?
  services     CreatorService[]
  payouts      CreatorPayout[]

  @@index([handle])
  @@index([userId], map: "idx_niche")
  @@map("creator_profiles")
}

// 3a. Creator Demographics (One-to-One with CreatorProfile)
model CreatorDemographics {
  creatorId    Int   @id @map("creator_id")
  ageRanges    Json? @map("age_ranges") // e.g., {"18-24": 40, "25-34": 30}
  genderSplit  Json? @map("gender_split") // e.g., {"Male": 45, "Female": 55}
  topCountries Json? @map("top_countries") // e.g., {"USA": 60, "UK": 20}

  creator CreatorProfile @relation(fields: [creatorId], references: [userId], onDelete: Cascade)

  @@map("creator_demographics")
}

// 3b. Creator Services / Rate Card (Many-to-One with CreatorProfile)
model CreatorService {
  id             Int     @id @default(autoincrement())
  creatorId      Int     @map("creator_id")
  title          String  @db.VarChar(100) // e.g., "Instagram Reel"
  description    String? @db.Text
  price          Decimal @db.Decimal(10, 2)
  turnaroundTime String? @map("turnaround_time") @db.VarChar(50) // e.g., "3 days"
  isEnabled      Boolean @default(true) @map("is_enabled")

  creator CreatorProfile @relation(fields: [creatorId], references: [userId], onDelete: Cascade)

  @@index([creatorId])
  @@map("creator_services")
}

// 4. Campaigns
model Campaign {
  id               Int             @id @default(autoincrement())
  brandId          Int             @map("brand_id")
  title            String          @db.VarChar(255)
  description      String?         @db.Text
  platformRequired String?         @map("platform_required") @db.VarChar(50)
  campaignType     String?         @map("campaign_type") @db.VarChar(50)
  status           CampaignStatus? @default(Draft)
  targetBudget     Decimal?        @map("target_budget") @db.Decimal(10, 2) // Single budget amount
  deadline         DateTime?       @db.Date

  // Contractual Details (New)
  usageRights            String? @map("usage_rights") @db.VarChar(100) // e.g., "30 Days", "Perpetual"
  usageCategory          String? @map("usage_category") @db.VarChar(100) // e.g., "Digital Only", "All Media"
  exclusivity            String? @map("exclusivity") @db.VarChar(100)
  exclusivityPeriod      Int?    @map("exclusivity_period") // Days
  isWhitelistingRequired Boolean @default(false) @map("is_whitelisting_required")
  contentUsageScope      String? @map("content_usage_scope") @db.VarChar(255) // e.g., "Organic, Paid Social"

  // Escrow / Vault
  escrowBalance   Decimal?      @default(0.00) @map("escrow_balance") @db.Decimal(10, 2)
  totalFunded     Decimal?      @default(0.00) @map("total_funded") @db.Decimal(10, 2) // Sum of all funding transactions
  totalReleased   Decimal?      @default(0.00) @map("total_released") @db.Decimal(10, 2) // Sum of creator payouts
  escrowStatus    EscrowStatus? @default(Locked) @map("escrow_status")
  payoutSpeed     PayoutSpeed?  @default(Standard) @map("payout_speed")
  escrowFundedAt  DateTime?     @map("escrow_funded_at")
  isGuaranteedPay Boolean       @default(false) @map("is_guaranteed_pay")

  createdAt DateTime @default(now()) @map("created_at")

  brand User @relation("BrandCampaigns", fields: [brandId], references: [id], onDelete: Cascade)

  collaborations CampaignCollaboration[]
  transactions   Transaction[]
  analytics      AnalyticsDaily[]

  @@index([status])
  @@map("campaigns")
}

// 5. Campaign Submissions / Collaborations
model CampaignCollaboration {
  id          Int           @id @default(autoincrement())
  campaignId  Int           @map("campaign_id")
  creatorId   Int           @map("creator_id")
  status      CollabStatus? @default(Applied)
  agreedPrice Decimal?      @map("agreed_price") @db.Decimal(10, 2)

  // Submission & Deliverables
  deliverables       Json? // Tracking specific items (e.g. { "script": "done", "draft": "pending" })
  deliverableVersion Int?    @default(1) @map("deliverable_version")
  submissionUrl      String? @map("submission_url") @db.VarChar(255)
  submissionTitle    String? @map("submission_title") @db.VarChar(255)
  submissionPlatform String? @map("submission_platform") @db.VarChar(50)
  submissionNotes    String? @map("submission_notes") @db.Text

  // Agreement & Tracking (New)
  milestones           Json? // e.g., { "Concept": "completed", "Script": "pending", ... }
  isWhitelisted        Boolean             @default(false) @map("is_whitelisted")
  whitelistingStatus   WhitelistingStatus? @default(None) @map("whitelisting_status")
  usageAgreed          String?             @map("usage_agreed") @db.VarChar(100)
  rightsExpirationDate DateTime?           @map("rights_expiration_date") @db.Date

  // Performance
  videoId    String? @map("video_id") @db.VarChar(100)
  videoStats Json?   @map("video_stats") // Keep for raw api response

  // Real-time Verified Metrics
  viewsCount     BigInt?  @default(0) @map("views_count")
  likesCount     Int?     @default(0) @map("likes_count")
  sharesCount    Int?     @default(0) @map("shares_count")
  engagementRate Decimal? @map("engagement_rate") @db.Decimal(5, 2)

  // Financial & Insurance Logic
  isInsured      Boolean   @default(false) @map("is_insured")
  payoutReleased Boolean   @default(false) @map("payout_released")
  payoutDate     DateTime? @map("payout_date")

  performanceMetrics Json?    @map("performance_metrics") // Normalized metrics (reach, shares, etc.)
  estimatedEmv       Decimal? @map("estimated_emv") @db.Decimal(10, 2)

  feedbackNotes String?  @map("feedback_notes") @db.Text
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  campaign         Campaign          @relation(fields: [campaignId], references: [id])
  creator          User              @relation("CreatorCollaborations", fields: [creatorId], references: [id])
  invoices         Invoice[]
  contentFeedbacks ContentFeedback[]

  @@map("campaign_collaborations")
}

// 6. Financial Transactions
model Transaction {
  id              Int                @id @default(autoincrement())
  userId          Int                @map("user_id")
  campaignId      Int?               @map("campaign_id")
  amount          Decimal            @db.Decimal(10, 2)
  type            TransactionType
  status          TransactionStatus? @default(Pending)
  description     String?            @db.VarChar(255)
  transactionDate DateTime           @default(now()) @map("transaction_date")

  // Tazapay Integration
  tazapayReferenceId String?   @map("tazapay_reference_id") @db.VarChar(100)
  checkoutUrl        String?   @map("checkout_url") @db.VarChar(500)
  gatewayStatus      String?   @map("gateway_status") @db.VarChar(50)
  processedAt        DateTime? @map("processed_at")

  // Fee Breakdown (stored for receipts)
  platformFee   Decimal? @map("platform_fee") @db.Decimal(10, 2)
  processingFee Decimal? @map("processing_fee") @db.Decimal(10, 2)
  netAmount     Decimal? @map("net_amount") @db.Decimal(10, 2)

  // Actual Received Amount (from payment gateway - may differ due to currency conversion)
  receivedAmount   Decimal? @map("received_amount") @db.Decimal(10, 2)
  receivedCurrency String?  @map("received_currency") @db.VarChar(10)

  metadata Json? // webhook payload storage

  user     User      @relation(fields: [userId], references: [id])
  campaign Campaign? @relation(fields: [campaignId], references: [id])

  @@map("transactions")
}

// 7. Analytics Data
model AnalyticsDaily {
  id               Int      @id @default(autoincrement())
  brandId          Int      @map("brand_id")
  campaignId       Int?     @map("campaign_id")
  recordDate       DateTime @map("record_date") @db.Date
  revenueGenerated Decimal? @default(0.00) @map("revenue_generated") @db.Decimal(10, 2)
  spendAmount      Decimal? @default(0.00) @map("spend_amount") @db.Decimal(10, 2)
  impressions      Int?     @default(0)
  clicks           Int?     @default(0)

  brand    User      @relation(fields: [brandId], references: [id])
  campaign Campaign? @relation(fields: [campaignId], references: [id])

  @@index([brandId, recordDate])
  @@map("analytics_daily")
}

// 8. Community Feed / Posts
model CommunityPost {
  id          Int        @id @default(autoincrement())
  userId      Int        @map("user_id")
  type        PostType
  contentText String?    @map("content_text") @db.Text
  mediaUrl    String?    @map("media_url") @db.VarChar(255)
  mediaType   MediaType? @default(none) @map("media_type")
  createdAt   DateTime   @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@map("community_posts")
}

// 9. Social Accounts
model SocialAccount {
  id                Int       @id @default(autoincrement())
  userId            Int       @map("user_id")
  platform          Platform
  username          String    @db.VarChar(100)
  handle            String?   @db.VarChar(100)
  providerAccountId String?   @map("provider_account_id") // Platform-specific user ID
  profileUrl        String?   @map("profile_url") @db.VarChar(255)
  accessToken       String?   @map("access_token") @db.Text
  refreshToken      String?   @map("refresh_token") @db.Text
  expiresAt         DateTime? @map("expires_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("social_accounts")
}

// 10. Invoices (New)
model Invoice {
  id              Int           @id @default(autoincrement())
  creatorId       Int           @map("creator_id")
  collaborationId Int?          @map("collaboration_id")
  invoiceNumber   String        @unique @map("invoice_number") @db.VarChar(50)
  brandName       String        @map("brand_name") @db.VarChar(100)
  campaignTitle   String?       @map("campaign_title") @db.VarChar(255)
  amount          Decimal       @db.Decimal(10, 2)
  status          InvoiceStatus @default(Draft)
  issuedAt        DateTime?     @map("issued_at")
  paidAt          DateTime?     @map("paid_at")
  taxYear         Int           @map("tax_year")
  pdfUrl          String?       @map("pdf_url") @db.VarChar(255)
  createdAt       DateTime      @default(now()) @map("created_at")

  creator       User                   @relation(fields: [creatorId], references: [id])
  collaboration CampaignCollaboration? @relation(fields: [collaborationId], references: [id])

  @@index([creatorId, taxYear])
  @@map("invoices")
}

// 11. Content Feedback (New)
model ContentFeedback {
  id              Int      @id @default(autoincrement())
  collaborationId Int      @map("collaboration_id")
  authorId        Int      @map("author_id")
  timestamp       Decimal  @db.Decimal(10, 2) // Video timestamp in seconds
  feedbackText    String   @db.Text
  feedbackType    String   @db.VarChar(50) // "change", "approve", "question"
  resolved        Boolean  @default(false)
  createdAt       DateTime @default(now()) @map("created_at")

  collaboration CampaignCollaboration @relation(fields: [collaborationId], references: [id])
  author        User                  @relation(fields: [authorId], references: [id])

  @@map("content_feedback")
}

// 12. Documents (Contracts, Tax Forms, NDAs)
model Document {
  id              Int            @id @default(autoincrement())
  creatorId       Int            @map("creator_id")
  collaborationId Int?           @map("collaboration_id")
  campaignId      Int?           @map("campaign_id")
  type            DocumentType
  title           String         @db.VarChar(255)
  description     String?        @db.Text
  status          DocumentStatus @default(Draft)

  // File Storage
  fileUrl       String? @map("file_url") @db.VarChar(500)
  signedFileUrl String? @map("signed_file_url") @db.VarChar(500)

  // E-Signature (DocuSeal)
  signatureId  String?   @map("signature_id") @db.VarChar(255)
  signedAt     DateTime? @map("signed_at")
  signedByName String?   @map("signed_by_name") @db.VarChar(100)

  // Metadata
  expiresAt DateTime? @map("expires_at")
  taxYear   Int?      @map("tax_year")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  creator User @relation(fields: [creatorId], references: [id])

  @@index([creatorId])
  @@map("documents")
}

// --- ENUMS ---

enum Role {
  brand
  creator
  admin
}

enum CompanySize {
  Startup
  Mid_Market @map("Mid-Market")
  Enterprise
}

enum HiringStatus {
  Active
  Hiring
  Paused
}

enum Platform {
  Instagram
  TikTok
  YouTube
  Twitch
  Twitter
  Other
}

enum CampaignStatus {
  Draft
  Active
  Completed
  Paused
}

enum CollabStatus {
  Applied
  Invited
  In_Progress  @map("In Progress")
  Under_Review @map("Under Review")
  Revision
  Approved
  Paid
}

enum TransactionType {
  Deposit
  Payment
  Withdrawal
  Refund
}

enum TransactionStatus {
  Pending
  Completed
  Failed
}

enum PostType {
  Casting_Call @map("Casting Call")
  Showcase
  General
}

enum MediaType {
  image
  video
  none
}

enum WhitelistingStatus {
  Requested
  Active
  Revoked
  None
}

enum EscrowStatus {
  Locked
  Released
  Refunded
}

enum PayoutSpeed {
  Instant // T+0, funds released immediately on approval
  Standard // Net-30 standard processing
}

enum VerificationTier {
  None
  Silver // 3+ completed, 80%+ on-time
  Gold // 10+ completed, 90%+ on-time
  Black // 25+ completed, 95%+ on-time
}

enum InvoiceStatus {
  Draft
  Sent
  Paid
  Cancelled
}

enum DocumentType {
  Contract
  W9
  NEC_1099     @map("1099-NEC")
  NDA
  MediaRelease @map("Media_Release")
  TaxForm      @map("Tax_Form")
  Other
}

enum DocumentStatus {
  Draft
  Pending_Signature @map("Pending_Signature")
  Signed
  Expired
  Voided
}

// 13. Meetings (Strategy Calls)
model Meeting {
  id        Int           @id @default(autoincrement())
  userId    Int?          @map("user_id") // Optional, if user is logged in
  name      String        @db.VarChar(100)
  email     String        @db.VarChar(255)
  role      String?       @db.VarChar(50) // brand/creator
  date      DateTime      @db.Date
  timeSlot  String        @map("time_slot") @db.VarChar(50)
  agenda    String?       @db.Text
  status    MeetingStatus @default(Scheduled)
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([email])
  @@index([date])
  @@map("meetings")
}

enum MeetingStatus {
  Scheduled
  Completed
  Cancelled
  Rescheduled
}

// === PAYOUT INTEGRATION ===

enum PayoutStatus {
  Inactive // Not set up
  Pending // Awaiting verification
  Active // Ready for payouts
  Suspended // Temporarily disabled
}

enum OnboardingStatus {
  NotStarted // Haven't started onboarding
  LinkGenerated // Onboarding link created, awaiting user
  InProgress // User is on Tazapay's hosted form
  PendingApproval // Submitted, awaiting Tazapay review
  Approved // Approved, ready for payouts
  Rejected // Rejected by Tazapay
}

enum PayoutTxStatus {
  Pending
  Processing
  Completed
  Failed
}

// 14. Creator Payouts (Payout History)
model CreatorPayout {
  id              Int            @id @default(autoincrement())
  creatorId       Int            @map("creator_id")
  collaborationId Int?           @map("collaboration_id")
  amount          Decimal        @db.Decimal(10, 2)
  currency        String         @default("USD") @db.VarChar(5)
  status          PayoutTxStatus @default(Pending)
  tazapayPayoutId String?        @map("tazapay_payout_id") @db.VarChar(100)
  payoutType      String?        @map("payout_type") @db.VarChar(20) // 'local' or 'wire'
  failureReason   String?        @map("failure_reason") @db.VarChar(255)
  initiatedAt     DateTime       @default(now()) @map("initiated_at")
  completedAt     DateTime?      @map("completed_at")

  creator CreatorProfile @relation(fields: [creatorId], references: [userId])

  @@index([creatorId, status])
  @@map("creator_payouts")
}
